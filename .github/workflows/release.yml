name: Release

on:
  push:
    tags:
    - 'v[0-9]+.[0-9]+.[0-9]+'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    name: Building for ${{ matrix.os }}
    runs-on: "${{ matrix.os }}"
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        rust: [stable]
        include:
        - os: macos-latest
          artifact_prefix: macos
          target: x86_64-apple-darwin
        - os: ubuntu-latest
          artifact_prefix: linux
          target: x86_64-unknown-linux-gnu
    steps:
    - name: Installing Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: "${{ matrix.rust }}"
        override: true
    - name: Checking out repository
      uses: actions/checkout@v2
    - name: Executing cargo build
      uses: actions-rs/cargo@v1
      with:
        command: build
        toolchain: "${{ matrix.rust }}"
        args: --release --target "${{ matrix.target }}"
    - name: Packaging final binary
      shell: bash
      run: |
        cd "target/${{ matrix.target }}/release"
        strip ksrt
        tar czvf "ksrt-${{ matrix.artifact_prefix }}.tar.gz" ksrt
        shasum -a 256 "ksrt-${{ matrix.artifact_prefix }}.tar.gz" > "ksrt-${{ matrix.artifact_prefix }}.sha256"
    - name: Uploading artifacts
      uses: actions/upload-artifact@v2
      with:
        name: "ksrt-${{ matrix.artifact_prefix }}"
        path: "target/${{ matrix.target }}/release/"

  package:
    name: Packaging artifacts
    needs: build
    runs-on: "${{ matrix.os }}"
    strategy:
      matrix:
        os: [ubuntu-latest]
        rust: [stable]
        include:
        - os: ubuntu-latest
          artifact_prefix: linux
          target: x86_64-unknown-linux-gnu
    steps:
    - name: Installing Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: "${{ matrix.rust }}"
        override: true
    - name: Installing prerequisites
      shell: bash
      run: |
        DEBIAN_FRONTEND=noninteractive sudo apt install -y rpm
    - name: Installing RPM packager
      uses: actions-rs/install@v0.1
      with:
        crate: cargo-rpm
        version: latest
        use-tool-cache: true
    - name: Checking out repository
      uses: actions/checkout@v2
    - name: Downloading artifacts
      uses: actions/download-artifact@v2
      with:
        name: "ksrt-${{ matrix.artifact_prefix }}"
        path: "target/release"
    - name: Packaging RPM
      uses: actions-rs/cargo@v1
      with:
        command: rpm
        toolchain: "${{ matrix.rust }}"
        args: build --no-cargo-build --target "${{ matrix.target }}"
    - name: Uploading artifacts
      uses: actions/upload-artifact@v2
      with:
        name: "ksrt-rpm"
        path: "target/release/rpmbuild/RPMs/x86_64/ksrt-*.x86_64.rpm"

  release:
    name: Creating release
    needs: [build, package]
    runs-on: ubuntu-latest
    steps:
    - name: Downloading artifacts
      uses: actions/download-artifact@v2
    - name: Releasing artifacts
      uses: softprops/action-gh-release@v1
      with:
        files: |
          "ksrt-*/ksrt-*.tar.gz"
          "ksrt-*/ksrt-*.sha256"
          "ksrt-*/ksrt-*.rpm"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

#   publish:
#     name: Publishing to Crates.io
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@master
#     - uses: actions-rs/toolchain@v1
#       with:
#         toolchain: stable
#         override: true
#     - uses: actions-rs/cargo@v1
#       with:
#         command: publish
#         args: --token {{ "${{ secrets.CARGO_API_KEY " }}}} --allow-dirty
